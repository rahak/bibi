Bibi for Pegasus Project
================================================================================================================================




設置ガイド
--------------------------------------------------------------------------------------------------------------------------------

クローンしたままの状態ではサーバに設置するプログラムファイルは含まれておらず、ソースコードだけが存在しています。
ただし、次のコマンドで最初のインストールを行うと、設置用のファイルが生成されます。

```sh
$ npm install
```

上のコマンドの実行後は、__dist フォルダ内に設置用のファイル／フォルダが生成されています。

```
+ __dist/
  + bibi/
    + and/**
    + extensions/**
    + presets/
      - pegasus.js
    + resources/**
    - index.html
  + bibi-bookshelf/
```

この __dist フォルダ内のファイル一式（bibi フォルダと bibi-bookshelf フォルダ）を、静的な HTTP サーバ上に配置してください。
※ 設置の前に、次項の手順に従ってローカル環境で確認しておくことをお勧めします。

また、次の場所には、Pegasus での確認用として、権利調整不要な暗号化済みEPUBサンプルファイルも同梱されています。これをサーバ上の bibi-bookshelf フォルダに入れると、挙動と表示の確認ができます（実際の利用時には設置不要です）。

```
+ pegasus-samples/
  - lenna.epub
```

例えば https://example.com/ のドキュメントルートに bibi フォルダと bibi-bookshelf フォルダを設置し、lenna.epub を bibi-bookshelf に入れた場合、次のURLでサンプル書籍を開くことができます。

```
https://example.com/bibi/?book=lenna.epub&key=0123456789abcdef0123456789abcdef
```

なお、以降の手順で説明するように __src 内でプリセットファイルの更新などを行ったあとは、__dist 上のファイル更新のために、（`npm install` ではなく）次のコマンドを利用してください。

```sh
$ npm run build
```



ローカル環境での確認
--------------------------------------------------------------------------------------------------------------------------------

ローカル環境で確認するためのサーバ機能が備わっており、次のコマンドで起動できます。

```sh
$ npm run serve
```

サーバを起動後は、下の例のようにパラメータを指定したURLで表示・動作の確認ができます。

```
http://localhost:61671/bibi/?book=lenna.epub&key=0123456789abcdef0123456789abcdef
```


### URL のパラメータについて

書式： http(s)://<設置先>/bibi/?book=<ファイル名>&key=<コンテンツ鍵文字列>

パラメータ名 | 例                                  | 内容               | 解説 
------------ | ----------------------------------- | ------------------ | ----
book         | `lenna.epub`                        | ファイル名         | プリセットファイルの`bookshelf`で指定したディレクトリを起点とした相対パス
key          | `0123456789abcdef0123456789abcdef`  | コンテンツ鍵文字列 | 




プリセットファイルの編集による設定変更
--------------------------------------------------------------------------------------------------------------------------------

プリセットファイル（`bibi/presets/pegasus.js`）内の値を変更することで、書籍データを置く場所などのカスタマイズが可能です。


#### 編集手順

__src 内のプリセットファイル（__src/bibi/presets/pegasus.js）を編集し、次のビルドコマンドを実行することで、__dist 内のプリセットファイル（__dist/bibi/presets/pegasus.js）が更新されます。

```sh
$ npm run build
```

設置先サーバへの反映は、この手順を経たうえで再度アップロードすることをお勧めします。

設置先の bibi/presets/pegasus.js を直接編集することでも設定変更は可能です。
しかしながら、設置先サーバ上での変更内容を後からローカル環境にも反映させたい場合は、上のとおり、__dist 内のプリセットファイルではなく __src 内のプリセットファイル（__src/bibi/presets/pegasus.js）を更新してビルドコマンドを実行するようにしてください。
__dist 内のプリセットファイル（__dist/bibi/presets/pegasus.js）は、ビルド処理によって常に __src 内のプリセットファイル（__src/bibi/presets/pegasus.js）で置き換えられるためです。

__dist/bibi 以下のファイルは、基本的にすべて、同じようにビルド処理で更新されます。
ただし、bibi-bookshelf フォルダはビルド処理の影響を受けず、逆に __src 内からビルド処理で複製されることもありませんので、__dist フォルダ内で直接管理してください。


#### 書籍データの設置場所（"bookshelf"）の変更

デフォルトでは、書籍データの設置場所は bibi フォルダと同階層の bibi-bookshelf フォルダになっています。
プリセットファイル内の "bookshelf" の指定を変更することで、書籍データの設置場所を bibi-bookshelf フォルダ以外の場所に変更することができます。

プリセットファイルからの相対パスで同一サーバ内の任意の場所を指定できるほか、別のサーバにあるディレクトリを http(s) から始まる URL で指定することもできます（末尾のスラッシュは不要です。つけられていても削除して扱われます）。
ただし、別のサーバを指定する際は、次項の内容に留意してください。

なお、もし "bookshelf" の指定先を bibi フォルダ内の任意のフォルダに変更した状態でビルド処理を実行しても、__dist/bibi 内のそのフォルダが削除されたりはしませんので、ローカル環境でのテスト用書籍データは、"bookshelf" を bibi-bookshelf から変更してもしなくても、__dist 内で直接管理することができます。




実際のコンテンツ配信に合わせた設定
--------------------------------------------------------------------------------------------------------------------------------

書籍データを bibi フォルダの設置先とは異なる外部のサーバ（CDN 等）に設置したい場合は、まず、書籍データを設置する側のサーバで、bibi フォルダ設置先サーバとの CORS（Cross-Origin Resource Sharing: オリジン間リソース共有）が許可されている必要があります。

さらに、プリセットファイルの設定にも変更が必要です。
前項および次の例を参考に、"bookshelf" を配信サーバ上のディレクトリまでの URL に変更して、"trustworthy-origins" に配信サーバのオリジンを追加してください。

項目名              | 内容
------------------- | ----
bookshelf           | bookパラメータの基点となるディレクトリのURL（例： "bookshelf": "https://lunascape.co.jp/pegasus-books", ）
trustworthy-origins | 書籍データの配信元として許可するオリジンの配列（例： "trustworthy-origins": ["https://lunascape.co.jp"], ）

